import{_ as Q,r as u,i as y,w as X,o as Y,j as Z,c as p,a as v,b as s,n as S,t as l,F as k,f as I,g as ee}from"./style-CUWtJf7Z.js";const se={class:"page"},te={class:"layout"},ae={class:"card detect-card"},ne={key:0,class:"detect-simple"},ie={key:1,class:"detect-body"},le={class:"detect-header"},ce={class:"status-title"},re={class:"muted small"},oe={class:"result-line"},de={class:"result-label"},ue={class:"muted tiny"},pe={class:"info-block"},ve={class:"ip-box mono"},fe={class:"details"},ye={class:"details-body mono tiny"},_e={class:"actions"},me=["disabled"],Ae={class:"side"},Te={class:"card side-card"},Ne={class:"accordion"},he={class:"muted tiny"},ge={class:"acc-body"},be={class:"muted small"},we={class:"muted tiny",style:{"margin-top":"6px"}},Ce={class:"muted tiny"},Pe={class:"muted tiny"},h="https://ai.koolcenter.com/natcheck",Se={__name:"App",setup(Ie){const U=["stun:stun1.ddnsto.com:3501","stun:stun2.ddnsto.com:3502","stun:stun.miwifi.com:3478"],r=u(""),_=u(""),T=u(""),g=u([]),d=u(""),f=u(!1),b=u([...U]),c=u("idle");let n=null,o=null,m=[],N=!1;const O=typeof window<"u"?new URLSearchParams(window.location.search||""):new URLSearchParams,E=a=>["1","true","yes","on"].includes((a||"").toLowerCase()),$=E(O.get("autorun")),L=E(O.get("postParent")),w=a=>{if(!L||typeof window>"u")return;const e=window.parent;if(!(!e||e===window))try{e.postMessage({source:"ai-portal-nat",...a},"*")}catch{}};function D(a){if(!a)return null;const e=a.toUpperCase();if(e.includes("NAT1"))return"NAT1";if(e.includes("NAT2"))return"NAT2";if(e.includes("NAT3"))return"NAT3";if(e.includes("NAT4"))return"NAT4";const t=a.toLowerCase();return t.includes("full cone")||t.includes("open internet")||t.includes("endpoint independent")?"NAT1":t.includes("restricted cone")?"NAT2":t.includes("port restricted")||t.includes("address and port dependent")?"NAT3":t.includes("symmetric")?"NAT4":null}const A=y(()=>{const a=_.value,e=D(a);return e?{NAT1:{label:"NAT1 · 全锥形",desc:"开放的连接，P2P 体验最佳",pill:"pill-nat1",card:"card-nat1"},NAT2:{label:"NAT2 · 受限锥形",desc:"良好连接，需先向外部发送数据",pill:"pill-nat2",card:"card-nat2"},NAT3:{label:"NAT3 · 端口受限",desc:"连接受限，可能需端口映射",pill:"pill-nat3",card:"card-nat3"},NAT4:{label:"NAT4 · 对称型",desc:"直连困难，通常需要中继",pill:"pill-nat4",card:"card-nat4"}}[e]:{label:"准备检测",desc:"点击开始检测您的 NAT 类型",pill:"pill-neutral",card:"card-neutral"}}),j=y(()=>A.value.card||""),B=y(()=>(g.value||[]).join(`
`)),F=y(()=>f.value?"检测中…":c.value==="success"?"重新检测":"开始检测"),J=y(()=>{switch(c.value){case"detecting":return"正在检测 NAT 类型";case"success":return"检测完成";case"error":return"检测失败";default:return"准备检测 NAT 类型"}}),G=y(()=>{switch(c.value){case"detecting":return"正在分析网络，请稍候…";case"success":return"结果已生成，可查看详情或重新检测";case"error":return"无法完成检测，请检查网络后重试";default:return"点击下方按钮开始检测您的网络 NAT 类型"}}),M=y(()=>{switch(c.value){case"detecting":return"icon-spin";case"success":return"icon-success";case"error":return"icon-error";default:return"icon-idle"}}),z=[{code:"NAT1",title:"全锥形 NAT",en:"Full Cone NAT",brief:"最开放，直连成功率最高。",desc:"任何外部主机只要知道公网 IP 和端口，就能向内网主机发送数据。",good:["P2P 连接成功率最高","游戏延迟最低","无需端口转发"],bad:["安全性相对较低"],pill:"pill-nat1"},{code:"NAT2",title:"受限锥形 NAT",en:"Restricted Cone NAT",brief:"平衡性能与安全，适合大多数应用。",desc:"需要先向外部主机发送数据，该外部主机才能回连。",good:["P2P 连接良好","安全性较好","适合大多数应用"],bad:["需要建立连接后才能通信"],pill:"pill-nat2"},{code:"NAT3",title:"端口受限锥形 NAT",en:"Port Restricted Cone NAT",brief:"限制更严格，部分应用可能受限。",desc:"需先向外部主机的特定端口发送数据，该端口才能回连。",good:["安全性更高","可以过滤端口"],bad:["P2P 可能受限","部分游戏可能异常"],pill:"pill-nat3"},{code:"NAT4",title:"对称型 NAT",en:"Symmetric NAT",brief:"最严格，直连困难，需要中继。",desc:"与不同外部主机通信时，会分配不同的公网端口。",good:["安全性最高","防护能力强"],bad:["P2P 连接困难","游戏/远程访问可能失败","通常需要中继服务器"],pill:"pill-nat4"}];function R(){if(_.value="",T.value="",r.value="",g.value=[],d.value="",c.value="idle",m=[],N=!1,o){try{o.close()}catch{}o=null}if(n){try{n.close()}catch{}n=null}}async function C(){R(),f.value=!0,c.value="detecting",r.value="准备 ICE 配置…";try{await W(),r.value="已发送 Offer，等待应答…"}catch{r.value="创建会话失败",c.value="error",f.value=!1}}function V(){R(),f.value=!1,r.value="已停止"}async function W(){n=new RTCPeerConnection({iceServers:b.value.map(i=>({urls:i}))}),n.createDataChannel("data"),n.onicecandidate=i=>{i.candidate?x(i.candidate):n&&n.iceGatheringState==="complete"&&P()},n.onicegatheringstatechange=()=>{n&&n.iceGatheringState==="complete"&&P()};const a=await n.createOffer();await n.setLocalDescription(a);const e=await fetch(`${h}/session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({"user-agent":navigator.userAgent,sdp:a.sdp,is_vip:!1})});if(!e.ok)throw new Error("session create failed");const t=await e.json();d.value=t.session_id,Array.isArray(t.ice_servers)&&t.ice_servers.length&&(b.value=t.ice_servers,n.setConfiguration({iceServers:t.ice_servers.map(i=>({urls:i}))})),t.sdp&&(await n.setRemoteDescription({type:"answer",sdp:t.sdp}),r.value="已收到应答，等待 ICE…"),m.length&&(m.forEach(i=>x(i)),m=[]),N&&(P(),N=!1),q()}async function x(a){if(!d.value){m.push(a);return}try{await fetch(`${h}/session/${d.value}/signal`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"candidate","ice-candidate":a})})}catch{}}async function P(){if(!d.value){N=!0;return}try{await fetch(`${h}/session/${d.value}/signal`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"complete"})})}catch{}}function q(){d.value&&(o=new EventSource(`${h}/events?session_id=${d.value}`),o.onmessage=async a=>{const e=JSON.parse(a.data||"{}");if(e.ice_servers)b.value=e.ice_servers,n&&n.setConfiguration({iceServers:e.ice_servers.map(t=>({urls:t}))});else if(e["ice-candidate"])try{n&&await n.addIceCandidate(e["ice-candidate"])}catch{}else e.nat_type&&(_.value=e.nat_type,r.value="检测完成",c.value="success",e.public_addr&&(T.value=e.public_addr),Array.isArray(e.candidates)&&(g.value=e.candidates),H(),f.value=!1)},o.onerror=()=>{r.value="事件流中断，自动重试…"})}function H(){if(n){try{n.close()}catch{}n=null}if(o){try{o.close()}catch{}o=null}}const K=(a="success")=>{var e,t;w({type:"nat-result",status:a,natType:_.value||"",natCode:D(_.value),natLabel:((e=A.value)==null?void 0:e.label)||_.value||"",natDesc:((t=A.value)==null?void 0:t.desc)||"",publicAddr:T.value||""})};return X(()=>c.value,a=>{L&&(a==="detecting"?w({type:"nat-status",status:"detecting"}):a==="success"?K("success"):a==="error"&&w({type:"nat-status",status:"error",message:r.value||""}))}),Y(()=>{$&&C()}),Z(()=>{V()}),(a,e)=>(v(),p("div",se,[e[11]||(e[11]=s("header",{class:"intro"},[s("div",null,[s("h1",null,"NAT 类型检测工具"),s("p",{class:"muted"},"快速检测您的网络 NAT 类型，了解网络连接特性")])],-1)),s("div",te,[s("section",ae,[c.value==="idle"&&!f.value?(v(),p("div",ne,[e[0]||(e[0]=s("div",{class:"status-icon icon-idle big"},null,-1)),e[1]||(e[1]=s("div",{class:"status-title"},"准备检测 NAT 类型",-1)),e[2]||(e[2]=s("div",{class:"muted small"},"点击下方按钮开始检测您的网络 NAT 类型",-1)),s("button",{class:"primary",onClick:C},"开始检测")])):(v(),p("div",ie,[s("div",le,[s("div",{class:S(["status-icon",M.value])},null,2),s("div",null,[s("div",ce,l(J.value),1),s("div",re,l(G.value),1)])]),s("div",{class:S(["result-chip",j.value])},[s("div",oe,[s("span",de,l(A.value.label),1)]),s("div",ue,l(A.value.desc),1)],2),s("div",pe,[e[3]||(e[3]=s("div",{class:"label"},"公网 IP",-1)),s("div",ve,l(T.value||"检测后显示"),1)]),s("details",fe,[e[4]||(e[4]=s("summary",null,[s("span",null,"检测详情"),s("span",{class:"arrow"},"▼")],-1)),s("div",ye,l(B.value||"尚未收到候选"),1)]),s("div",_e,[s("button",{class:"primary",disabled:f.value,onClick:C},l(F.value),9,me)])]))]),s("aside",Ae,[s("div",Te,[e[8]||(e[8]=s("div",{class:"side-title"},"NAT 类型说明",-1)),e[9]||(e[9]=s("p",{class:"muted tiny"},"NAT 影响网络连接性能和 P2P 应用体验",-1)),s("div",Ne,[(v(),p(k,null,I(z,t=>s("details",{key:t.code},[s("summary",{class:S(["acc-header",t.pill])},[s("span",null,l(t.title),1),s("span",he,l(t.en),1),e[5]||(e[5]=s("span",{class:"arrow"},"▼",-1))],2),s("div",ge,[s("div",be,l(t.brief),1),s("div",we,l(t.desc),1),e[6]||(e[6]=s("div",{class:"muted tiny",style:{"margin-top":"6px"}},"优势：",-1)),s("ul",Ce,[(v(!0),p(k,null,I(t.good,i=>(v(),p("li",{key:i},"✓ "+l(i),1))),128))]),e[7]||(e[7]=s("div",{class:"muted tiny",style:{"margin-top":"6px"}},"限制：",-1)),s("ul",Pe,[(v(!0),p(k,null,I(t.bad,i=>(v(),p("li",{key:i},"✗ "+l(i),1))),128))])])])),64))])]),e[10]||(e[10]=s("div",{class:"card tip-card"},[s("div",{class:"side-title"},"使用提示"),s("ul",{class:"muted tiny"},[s("li",null,"如果是 NAT3 或 NAT4，可能需要配置路由器的 UPnP 或端口转发。"),s("li",null,"使用有线连接通常比 Wi-Fi 更稳定。"),s("li",null,"不同时间检测可能有不同结果，建议多次测试。")])],-1))])])]))}},ke=Q(Se,[["__scopeId","data-v-d2f8de38"]]);ee(ke).mount("#app");
