<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAT 类型检测工具（国内服务器版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #2c3e50;
        }
        .container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            background-color: #f9f9f9;
        }
        #startBtn {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }
        #startBtn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .server-list {
            margin: 1rem 0;
        }
        .server-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem;
            border-bottom: 1px dashed #e0e0e0;
        }
        .server-name {
            flex: 2;
        }
        .server-status {
            flex: 1;
            text-align: center;
        }
        .server-delay {
            flex: 1;
            text-align: center;
        }
        .success {
            color: #27ae60;
        }
        .timeout {
            color: #e74c3c;
        }
        .pending {
            color: #f39c12;
        }
        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 4px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
        }
        #natType {
            font-weight: bold;
            font-size: 1.2rem;
            color: #2980b9;
        }
        .note {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #7f8c8d;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <h1>NAT 类型检测工具（国内服务器版）</h1>
    <div class="container">
        <button id="startBtn">开始检测</button>
        <div class="server-list">
            <div class="server-item">
                <div class="server-name"><strong>服务器</strong></div>
                <div class="server-status"><strong>状态</strong></div>
                <div class="server-delay"><strong>延迟(ms)</strong></div>
            </div>
            <div id="serverContainer"></div>
        </div>
        <div id="result">
            <p>检测结果：<span id="natType">未检测</span></p>
            <p>公网反射地址：<span id="reflectAddr">未获取</span></p>
        </div>
    </div>
    <div class="note">
        <p>⚠️ 检测说明：</p>
        <p>1. 基于 WebRTC 实现，需浏览器支持（Chrome/Firefox/Edge 等主流浏览器均可）</p>
        <p>2. 超时阈值设置为 10000ms，避免国内服务器网络波动导致检测失败</p>
        <p>3. 支持的服务器：华为云、小米、中国电信、中国移动、Mozilla 中国、B站、Cloudflare</p>
    </div>

    <script>
        // 国内稳定 STUN 服务器列表（包含用户指定的服务商）
        const STUN_SERVERS = [
            { name: "Cloudflare", url: "stun:stun.cloudflare.com:3478" },
            { name: "Mozilla 中国", url: "stun:stun.services.mozilla.com:3478" },
            { name: "中国电信", url: "stun:stun.ctrip.com:3478" },
            { name: "中国移动", url: "stun:stun.126.com:3478" },
            { name: "华为云", url: "stun:stun.huaweicloud.com:3478" },
            { name: "小米", url: "stun:stun.mi.com:3478" },
            { name: "B站", url: "stun:stun.bilibili.com:3478" }
        ];

        const TIMEOUT = 10000; // 10000ms 超时
        let peerConnection = null;
        let reflectAddresses = [];
        let startTimeMap = new Map();

        // DOM 元素
        const startBtn = document.getElementById("startBtn");
        const serverContainer = document.getElementById("serverContainer");
        const natType = document.getElementById("natType");
        const reflectAddr = document.getElementById("reflectAddr");

        // 初始化服务器列表 UI
        function initServerList() {
            serverContainer.innerHTML = "";
            STUN_SERVERS.forEach(server => {
                const item = document.createElement("div");
                item.className = "server-item";
                item.id = `server-${server.name}`;
                item.innerHTML = `
                    <div class="server-name">${server.name}</div>
                    <div class="server-status pending">检测中</div>
                    <div class="server-delay">-</div>
                `;
                serverContainer.appendChild(item);
            });
        }

        // 更新服务器检测状态
        function updateServerStatus(serverName, status, delay = "-") {
            const item = document.getElementById(`server-${serverName}`);
            if (!item) return;
            const statusEl = item.querySelector(".server-status");
            const delayEl = item.querySelector(".server-delay");
            statusEl.className = `server-status ${status}`;
            statusEl.textContent = status === "success" ? "成功" : "超时";
            delayEl.textContent = delay === "-" ? "-" : `${delay}ms`;
        }

        // 分析 NAT 类型
        function analyzeNATType(reflectAddrs) {
            if (reflectAddrs.length === 0) return "未获取到反射地址";
            // 提取所有反射地址的 IP+端口
            const addrSet = new Set(reflectAddrs.map(addr => addr.split(":").slice(0, 2).join(":")));
            const ipSet = new Set(reflectAddrs.map(addr => addr.split(":")[0]));

            if (addrSet.size === 1) {
                return "全锥型 NAT";
            } else if (ipSet.size === 1) {
                return "地址受限锥型 NAT";
            } else if (reflectAddrs.length > 0 && addrSet.size === reflectAddrs.length) {
                return "对称型 NAT";
            } else {
                return "端口受限锥型 NAT";
            }
        }

        // 开始检测
        async function startDetection() {
            // 重置状态
            startBtn.disabled = true;
            initServerList();
            reflectAddresses = [];
            startTimeMap.clear();
            natType.textContent = "检测中...";
            reflectAddr.textContent = "检测中...";

            // 配置 ICE 服务器
            const iceServers = STUN_SERVERS.map(server => ({ urls: server.url }));
            peerConnection = new RTCPeerConnection({ iceServers });

            // 监听 ICE 候选地址
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidate = event.candidate.candidate;
                    // 筛选服务器反射候选地址（srflx 类型）
                    if (candidate.includes("srflx")) {
                        const addr = candidate.split(" ")[4] + ":" + candidate.split(" ")[5];
                        const serverName = Array.from(startTimeMap.keys()).find(name => {
                            return candidate.includes(STUN_SERVERS.find(s => s.name === name).url.split(":")[1]);
                        });
                        
                        if (serverName && !reflectAddresses.includes(addr)) {
                            reflectAddresses.push(addr);
                            const delay = Date.now() - startTimeMap.get(serverName);
                            updateServerStatus(serverName, "success", delay);
                        }
                    }
                }
            };

            // 创建虚拟数据流触发 ICE 收集
            try {
                const dataChannel = peerConnection.createDataChannel("dummy-channel");
                await peerConnection.createOffer({ offerToReceiveAudio: false, offerToReceiveVideo: false });
            } catch (e) {
                console.error("检测出错:", e);
            }

            // 设置超时
            STUN_SERVERS.forEach(server => {
                startTimeMap.set(server.name, Date.now());
                setTimeout(() => {
                    const item = document.getElementById(`server-${server.name}`);
                    if (item && item.querySelector(".server-status").textContent === "检测中") {
                        updateServerStatus(server.name, "timeout");
                    }
                }, TIMEOUT);
            });

            // 全局超时
            setTimeout(() => {
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                startBtn.disabled = false;
                // 分析结果
                const type = analyzeNATType(reflectAddresses);
                natType.textContent = type;
                reflectAddr.textContent = reflectAddresses.length > 0 ? reflectAddresses[0] : "未获取";
            }, TIMEOUT + 1000);
        }

        // 绑定事件
        initServerList();
        startBtn.addEventListener("click", startDetection);
    </script>
</body>
</html>
